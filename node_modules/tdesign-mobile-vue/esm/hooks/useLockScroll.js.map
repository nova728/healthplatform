{"version":3,"file":"useLockScroll.js","sources":["../../src/hooks/useLockScroll.ts"],"sourcesContent":["import { Ref, watch, onMounted, onActivated, onBeforeUnmount, onDeactivated, nextTick } from 'vue';\nimport { useTouch } from '../_util/useTouch';\nimport getScrollParent from '../_util/getScrollParent';\nimport { supportsPassive } from '../_util/supportsPassive';\n\nlet totalLockCount = 0;\nlet mounted: boolean = null;\n\n// 移植自vant：https://github.com/youzan/vant/blob/HEAD/src/composables/use-lock-scroll.ts\nexport function useLockScroll(rootRef: Ref<HTMLElement | undefined>, shouldLock: () => boolean, componentName: string) {\n  const touch = useTouch();\n  const BODY_LOCK_CLASS = `${componentName}--lock`;\n\n  const onTouchMove = (event: TouchEvent) => {\n    touch.move(event);\n\n    const direction = touch.deltaY.value > 0 ? '10' : '01';\n    const el = getScrollParent(event.target as Element, rootRef.value) as HTMLElement;\n    if (!el) return;\n    const { scrollHeight, offsetHeight, scrollTop } = el;\n    let status = '11';\n\n    if (scrollTop === 0) {\n      status = offsetHeight >= scrollHeight ? '00' : '01';\n    } else if (scrollTop + offsetHeight >= scrollHeight) {\n      status = '10';\n    }\n\n    if (status !== '11' && touch.isVertical() && !(parseInt(status, 2) & parseInt(direction, 2))) {\n      if (event.cancelable) {\n        event.preventDefault();\n      }\n    }\n  };\n\n  const lock = () => {\n    document.addEventListener('touchstart', touch.start);\n    document.addEventListener('touchmove', onTouchMove, supportsPassive.value ? { passive: false } : false);\n\n    if (!totalLockCount) {\n      document.body.classList.add(BODY_LOCK_CLASS);\n    }\n\n    totalLockCount += 1;\n  };\n\n  const unlock = () => {\n    if (totalLockCount) {\n      document.removeEventListener('touchstart', touch.start);\n      document.removeEventListener('touchmove', onTouchMove);\n\n      totalLockCount -= 1;\n\n      if (!totalLockCount) {\n        document.body.classList.remove(BODY_LOCK_CLASS);\n      }\n    }\n  };\n\n  const init = () => shouldLock() && lock();\n\n  const destroy = () => shouldLock() && unlock();\n\n  onMounted(() => {\n    init();\n    nextTick(() => {\n      mounted = true;\n    });\n  });\n\n  onActivated(() => {\n    if (mounted) {\n      init();\n    }\n  });\n\n  onDeactivated(destroy);\n  onBeforeUnmount(destroy);\n\n  watch(shouldLock, (value) => {\n    value ? lock() : unlock();\n  });\n}\n"],"names":["totalLockCount","mounted","useLockScroll","rootRef","shouldLock","componentName","touch","useTouch","BODY_LOCK_CLASS","onTouchMove","event","move","direction","deltaY","value","el","getScrollParent","target","scrollHeight","offsetHeight","scrollTop","status","isVertical","parseInt","cancelable","preventDefault","lock","document","addEventListener","start","supportsPassive","passive","body","classList","add","unlock","removeEventListener","remove","init","destroy","onMounted","nextTick","onActivated","onDeactivated","onBeforeUnmount","watch"],"mappings":"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"}